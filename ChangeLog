2007-02-10  Matthieu Lemerre  <racin@free.fr>

	Better derived type support : creators and accessers, some more
	errors catched.

	* test/malebolge07-creator.l: New test file.

	* src/std/init_library.c (init_library): Initialise the creator.
	* src/std/Makefile.am (libl_std_la_SOURCES): Added creator.c
	* src/std/creator.c: New file.
	* src/include/l/sys/creator.h: New file.
	* src/include/l/creator.h: New file.
	* src/expander/expand.c (expand_label): New expander. Initialized.

	* src/expander/access.c (get_accesser, get_left_accesser):
	New (private) functions.
	(derived_accesser, derived_left_accesser): New accesser, for
	derived types.
	(define_left_accesser): Corrected type of the argument

	* src/compiler/type.c (make_type_struct): Associates the structure
	type with a creator.
	(make_type_pointer): Same for the pointer type.
	* src/compiler/analysis.c (define_type): Creates a creator, an
	accesser, and a left accesser for the created type.

		
	* src/parser/parse.c (parse_indirection_type_form): Corrected a
	bug that prevented types like Int ** to be parsed.
	
	* src/expander/expand.c (insert_id): Check if id already present,
	or if it shadows an existing identifier.

	* src/compiler/generate.c (type_check): Better error message.

2007-02-05  Matthieu Lemerre  <racin@free.fr>

	* test/cocyte17-struct-copy.l: New test file.

	* src/parser/parse.c: New COLON token.
	(parse_labelled_expression): New grammar rule.
	(parse_tuple): Now use parse_labelled_expression instead of simple
	expression.

	* src/expander/expand.c (expand_struct): New expander.
	(init_expand): Initialize it.

	* src/compiler/jit/backend.c (move_between_big_locations): New
	function.
	(move_between_locations): Add call to move_between_big_locations
	if needed.
	(create_anonymous_stack_variable): New function.
	* src/compiler/generate.c (compile): Now pass the type as an
	argument to compilers.
	(compile_struct): New compiler. 
	(init_generate): Initialize it.
	* src/objects/function.h: Add support for passing types too.


2007-02-05  Matthieu Lemerre  <racin@free.fr>

        Corrected a bug that caused non-word stack allocations to overlap.
	
	* src/compiler/jit/stack.c (allocate_memory_block): Returns an
	offset that points to the beginning of the allocation zone.
 
2007-02-03  Matthieu Lemerre  <racin@free.fr>

	Basic tuple support & little form cleanup.
	
	* test/cocyte16-basic-tuple.l : New test file.

	* src/parser/parse.c (parse_primary_expression): Removed old
	assertion that prevented parsing of tuples of more than 1
	component.

	* src/parser/form.h : Remove form definitions of obsolete forms.

	* src/parser/form.c (void_form): Changed body to use generic_form
	instead of obsolete tuple_form.
 
	* src/expander/left-expand.c (left_expand_tuple): New function. Added in the
	initialisation.

	* src/expander/expand.c (expand_tuple): New function. Added in the
	initialisation.

	* src/compiler/jit/backend.c (compound_location): Changed function
	body.
	(copy_location): New function.
	(void_location): Now use the standard compound_location.
	(spill): Added somme assertions.
	(move_between_compound_locations): New function.
	(move_between_locations): Check if locations is compound, then
	calls move_between_compound_locations.
	(free_location): Added support to compound_locations.
	(free_location): Commented out a wrong assertion.

	* src/compiler/generate.c (compile_tuple): New function.  Added in
	the initialisation.

	* src/compiler/backend.h (struct location): New fields
	location_length, locations for compound location.

2007-02-03  Matthieu Lemerre  <racin@free.fr>

	* src/include/l/sys/hash.h (gethash): Add casts to suppress some
	warnings.
	(gethash_string): Likewise.

2007-02-01  Matthieu Lemerre  <racin@free.fr>

	Corrected a few things not commited in previous revision.
	
	* test/malebolge06-form.l: add f Form.

	* src/std/l-form.c:  Fix include.

2007-02-01  Matthieu Lemerre  <racin@free.fr>

	New set of functions and macros for manipulating L forms from L.
	
	* test/malebolge06-form.l: New test file.
	
	* src/include/l/form.h: New file.
	
	* src/std/init_library.c (init_library): Call init_form().
	* src/std/l-form.c: New file.
	* src/std/list.c (expand_list): Remove call to lispify().
	* src/std/Makefile.am (libl_std_la_SOURCES): add l-form.c.

	* src/parser/parse.c: Changed the lexer and parser to handle $ and $@.
	(l_parse_statement_or_expression): New function.
	* src/parser/form.c (init_form): Move some function definitions to
	L to l-form.c.
	

2007-01-31  Matthieu Lemerre  <racin@free.fr>

	Compiler bug fixed and some checks added.

	* src/compiler/jit/low-location.c (move_between_low_locations_funparm_any): 
	Fix a bug that prevented a temporary register to be freed when not
	used anymore.
	
	* src/main.c (main): Added a check that fails if the test()
	function does not exists.

	* src/eval.c (eval): Comment added; remove it to see the compiled
	function.

2007-01-28  Matthieu Lemerre  <racin@free.fr>

	Hash_String table support.

	* test/malebolge05-hash.l (test): Test Hash_Strings too.

	* src/std/hash.c (expand_hash_string, hash_string_accesser)
	(hash_string_left_accesser, make_type_Hash_String): New functions.
	(init_hash): use the above functions.
	
	* src/include/l/sys/hash.h (make_hash_string_table)
	(gethash_string, puthash_string): New functions.
	(hash_string_table_t): New type.

	* src/include/l/string.h (make_C_string_from_L_string): Function
	for L->C strings.
	(STRING): New macro, for C->L strings.

2007-01-27  Matthieu Lemerre  <racin@free.fr>

	* test/malebolge05-hash.l (test): Just adds another test with
	Hash(Int, Int).

2007-01-27  Matthieu Lemerre  <racin@free.fr>
	
	Hash table support.

	* src/objects/hash.h Moved relevant definitions to ...
	* src/include/l/sys/hash.h Here. Fixed includes.

	* test/malebolge05-hash.l : New file.
	* src/std/hash.c : New file.
	* src/std/init_library.c (init_library): Calls init_hash().
	* src/std/Makefile.am (libl_std_la_SOURCES): add hash.c

2007-01-27  Matthieu Lemerre  <racin@free.fr>

	Square brackets handling and lexer/parser bug fixes.
	
	* src/parser/parse.c : Change to handle the square brackets.
	(parse_postfix_expression): Corrected a bug in '.' handling.
	* src/lexer/character_set.c (single_char_character_set): New
	function.
	* src/lexer/nfa.c (parse_regexp): Corrected an error in the 
	handling of '\'.

2007-01-27  Matthieu Lemerre  <racin@free.fr>

	Left expanders and left accessers support.

	* src/include/l/access.h: Now handles the left accessers too.
	* src/include/l/expand.h: Handles also the left expanders.

	* src/expander/left-expand.c: New file.
	
	* src/expander/expand.c (expand_assign): Now calls left_expand.
	(init_expand): Calls the left expander initialisation function.
	
	* src/expander/access.c (define_left_accesser)
	(left_expand_access, struct_left_accesser)
	(pointer_left_accesser): New functions.
	(left_accesser_hash): New hash table.
	(init_access): Now defines the left expander for [].

	* src/expander/Makefile.am (libl_expand_la_SOURCES): added
	left-expand.c

	* src/compiler/type.c (make_type_struct): Register the type
	left accesser to use struct_left_accesser.
	(make_type_pointer): Use pointer_left_accesser.

	* test/malebolge01-pointer-access.l: Test auto deref when used as
	a lvalue.
	

2007-01-25  Matthieu Lemerre  <racin@free.fr>

	Enhanced accesser, and asprint_type cleanup.
	
	* src/expander/Makefile.am (libl_expand_la_SOURCES): Add access.c
	* src/expander/access.c : New file.
	(expand_access, pointer_accesser, struct_accesser): moved from
	expand.c.
	(define_accesser): New function.
	(init_access): New function.
	(accesser_hash): New hash table.
	(expand_access): Now use the accesser_hash.
	* src/expander/expand.c (init_expand): Now calls init_access. 
	* src/compiler/type.c (make_type_struct): Set the created type to
	use the struct accesser.
	(make_type_pointer): Set it to use the pointer accesser.
	* src/include/l/access.h: New file.

	* src/compiler/type.c (asprint_type): Now takes a Type argument.
	(asprint_type_form): Old asprint_type function.
	Fixed all callers.


2007-01-24  Matthieu Lemerre  <racin@free.fr>

	Yet another cleanup.
	
	* src/compiler/type.c: Cleaned up the file.
	* src/include/l/sys/type.h: New file.
	* src/include/l/type.h: Cleaned up, splitted with sys/type.h.
	Fix some source files to use sys/type.h.
	* src/objects/symbol.h: Fixed a circular header dependency.
	* src/std/list.c (make_type_List): Moved from compiler/type.c
	(init_list): Use new type constructor interface.

2007-01-23  Matthieu Lemerre  <racin@free.fr>

	Another cleanup pass.

	* src/objects/type.h: Removed file.
	* src/objects/pair.c: Cleaned up all useless functions.
	* src/objects/symbol.c: Likewise.
	
	* src/compiler/generate.c (struct_accessor): Likewise.
	* src/compiler/analysis.c (init_analysis): Remove useless declaration.
	* src/parser/form.c: Likewise.


2007-01-22  Matthieu Lemerre  <racin@free.fr>

	Little additional cleanup.

	* src/objects/fixnum.c : File removed.
        * src/objects/fixnum.h : File removed.
        * src/objects/function.c : File removed.
        * src/objects/object.h : File removed.
        * src/objects/string.c : File removed.

	Fixed includes.


2007-01-22  Matthieu Lemerre  <racin@free.fr>

	Cleaned up the type handling.
	
	* src/compiler/type.c (type_hash): removed hash table.
	(make_type): Now quits properly when given an unknown type.
	(intern_type): Removed the special case that used the type_hash.
	(TYPE): New function.
	(define_type_type_form): New function.
	(define_type_string): New function.
	* src/include/l/type.h (TYPE): Removed macro. Added TYPE function.

	* src/compiler/generate.c: Use new function TYPE.  Replaced int by
	Int, void by Void.
	* src/compiler/jit/backend.c (free_location): Likewise.
	* src/compiler/jit/operations.c : Likewise.
	* src/parser/form.c: Likewise.
	* src/std/list.c: Likewise.
	* src/std/output.c: Likewise.
	* src/std/print.c: Likewise.
	* src/std/xml.c: Likewise.
	* test/cocyte12-structures.l: Likewise.
	* test/cocyte15-rec-types.l: Likewise.
	
	* src/objects/object.h (CREATE_OBJECT): Removed use of TYPE.
	* src/objects/symbol.h: Likewise.
	* src/objects/type.h: Likewise.
	
	* src/compiler/c-to-l.h (DEFINE_TYPE_SYMBOL, DEFINE_TYPE): Removed
	macros.
	* src/compiler/analysis.c (init_analysis): Replace DEFINE_TYPE by
	define_type_string.
	(define_type_alias): Triggers a panic.
	(define_type): Uses define_type_type_form.

2007-01-20  Matthieu Lemerre  <racin@free.fr>

	* src/parser/parse.c (parse): New parser entry point, takes a
	String argument.
	(parse_file): Removed function.
	Fixed header parse.h

	* src/include/l/string.h (make_heap_string): Changed to have a
	trailing 0.
	
	* src/main.c (main): Now calls eval_file.
	(maken_heap_string): Same thing.
	* src/eval.c (eval): New file.
	* src/Makefile.am (L_SOURCES): added eval.c

2007-01-18  Matthieu Lemerre  <racin@free.fr>

	* src/std/print.c : New file.
	* src/std/output.c: New file.
	* src/std/init_library.c (init_library): Calls also init_output() and init_print()
	* src/std/Makefile.am (libl_std_la_SOURCES): added output.c and print.c

	* src/parser/parse.c (l_parse_statement): New function
	* src/parser/buffer.h : Changed inline functions to static inline.
	* src/include/l/std/output.h: New file.
	* src/include/l/string.h (struct string): a String and its content
	are not forced to be allocated at the same place; fixed other
	files to take this into account.

	* src/expander/expand.c (expand_block): Added a check on blocks not being empty.
	* src/compiler/c-to-l.h: added the TYPE_ macro
	* src/Makefile.am (L_LDADD): Added -lm

2007-01-17  Matthieu Lemerre  <racin@free.fr>

	* src/parser/form.c (lispify_rec): Use string_t instead of char *.

2007-01-14  Matthieu Lemerre  <racin@free.fr>

	* src/include/type.h : New location for the old compiler/type.h
	file.
	* src/include/string.h : New string structure.
	* src/objects/string.h: Removed file
	* src/compiler/type.h: Removed file
	All including files changes.
	
	* src/std/xml.c: Use string_t instead of char *.
	* src/parser/parse.c (get_next_token): Now creates a string_t
	* src/parser/form.c (string_form): Now takes a string_t instead of
	char *.

2007-01-13  Matthieu Lemerre  <racin@free.fr>

	* doc: New directory, holding L's documentation.
	* configure.in: Added doc/Makefile
	* Makefile.am: Added doc

2007-01-06  Matthieu Lemerre  <racin@free.fr>

	* Initial public release

